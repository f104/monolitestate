appResultMapConfig=appResultMapConfig||{},$(document).ready(function(){appResultMap.initialize()});var appResultMap={initialized:!1,loaded:!1,firstTime:!0,options:{urlPlaces:"https://api.myjson.com/bins/nawq6",urlItems:"onmap-list.html",params:{}},initialize:function(){if(!this.initialized&&0!==$("#result_map").length&&"undefined"!=typeof ymaps){for(i in appResultMapConfig)this.options[i]=appResultMapConfig[i];this.$cnt=$(".result-map"),ymaps.ready(this.initMap),this.initialized=!0}},initMap:function(){var t=new ymaps.Map("result_map",{center:[56.25471469870076,43.947964454589815],zoom:12,controls:[],margin:30},{suppressMapOpenBlock:!0});t.behaviors.disable("scrollZoom"),$(".js-map__zoom").on("click",function(){var e=t.getZoom();$(this).hasClass("_in")?e++:e--,t.setZoom(e,{checkZoomRange:!0,duration:200})}),closeButton=new ymaps.control.Button({data:{title:"Закрыть карту",image:"map-close.svg"},options:{maxWidth:90,selectOnClick:!1}}),closeButton.events.add("click",function(e){appResultMap.hide()}),appResultMap.closeButton=closeButton;var o=new ymaps.ObjectManager({clusterize:!0,gridSize:128,geoObjectOpenBalloonOnClick:!1}),e=ymaps.templateLayoutFactory.createClass('<div class="placemark _total _primary"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 8.202 11.113" class=""><path d="M4.101 11.113c2.734-3.12 4.101-5.442 4.101-6.968C8.202 1.855 6.366 0 4.101 0 1.836 0 0 1.856 0 4.145c0 1.526 1.367 3.849 4.101 6.968z" fill="#fff"></path></svg><span>{{ properties.total }}</span>{% if properties.hint %}<div class="placemark__hint">{{ properties.hint }}</div>{% endif %}</div>'),a=ymaps.templateLayoutFactory.createClass('<div class="result-map__balloon">{{ properties.content|raw }}<span class="spacer"></span></div>',{build:function(){a.superclass.build.call(this),$(".onmap__list .scrollbar-outer").scrollbar(),this._$element=$(".result-map__balloon",this.getParentElement())},getShape:function(){if(!this._isElement(this._$element))return a.superclass.getShape.call(this);var e=this._$element.position();return new ymaps.shape.Rectangle(new ymaps.geometry.pixel.Rectangle([[e.left,e.top],[e.left+this._$element[0].offsetWidth,e.top+this._$element[0].offsetHeight+this._$element.find(".spacer")[0].offsetHeight]]))},_isElement:function(e){return e&&e[0]&&e.find(".spacer")[0]}});o.objects.options.set({iconLayout:e,iconShape:{type:"Rectangle",coordinates:[[-15.5,-42],[15.5,0]]},hideIconOnBalloonOpen:!1,balloonLayout:a,balloonCloseButton:!1,balloonPanelMaxMapArea:0}),o.clusters.options.set("preset","islands#darkBlueCircleIcon"),t.geoObjects.add(o),o.objects.events.add("click",function(e){var t=e.get("objectId"),a=o.objects.getById(t);if(o.objects.balloon.isOpen(t))o.objects.balloon.close();else if(a.properties.content)o.objects.balloon.open(t);else{a.properties.content='<span class="result-map__balloon__loading"><i class="icon-spin"></i></span>',o.objects.balloon.open(t);var s=$.extend({coordinates:a.geometry.coordinates},appResultMap.options.params);$.get(appResultMap.options.urlItems,s,function(e){a.properties.content=e,o.objects.balloon.setData(a)})}}),appResultMap.map=t,appResultMap.om=o,$(".result-map__hover").on("click",function(){appResultMap.show()}),$(document).on("mse2_load",function(e,t){appResultMap.update()}),t.events.add("boundschange",function(e){$(document).trigger("app_map_changed",{firstTime:appResultMap.firstTime,bounds:e.get("newBounds")})})},show:function(){this.loaded?(this.$cnt.addClass("_expanded"),this.map.controls.add(this.closeButton,{float:"right",floatIndex:1}),this.map.controls.add("fullscreenControl",{floatIndex:0})):this.load()},hide:function(){var t=this;setTimeout(function(){t.$cnt.removeClass("_expanded");var e=t.map.controls.get("fullscreenControl");null!==e&&e.exitFullscreen(),t.map.controls.remove("fullscreenControl"),t.map.controls.remove(this.closeButton)},500)},load:function(){appResultMap.$cnt.addClass("_loading"),$.get(this.options.urlPlaces,this.options.params,function(e){e?(appResultMap.om.add(e),appResultMap.$cnt.addClass("_expanded"),appResultMap.$cnt.removeClass("_loading"),appResultMap.loaded=!0,appResultMap.show(),appResultMap.reset()):(appResultMap.$cnt.removeClass("_loading"),miniShop2.Message.info("Нет данных для отображения на карте"))})},update:function(){this.loaded&&(this.om.removeAll(),$.get(this.options.urlPlaces,this.options.params,function(e){e&&(appResultMap.om.add(e),appResultMap.firstTime=!0,appResultMap.reset())}))},reset:function(){this.loaded&&(this.map.balloon.close(),this.map.setBounds(this.om.getBounds(),{checkZoomRange:!0,zoomMargin:30,useMapMargin:!0}).then(function(){appResultMap.firstTime=!1}))}};